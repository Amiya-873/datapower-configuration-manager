<?xml version="1.0"?>
<!--
/**
 * Copyright 2014 IBM Corp.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
-->

<!--
	Produce a new version of DCM for distribution.
-->
<project name="dcm-distribution" basedir="." default="main">

	<fail message="Specify a version number (e.g. 2.0.1) as the property 'dcm.version'." unless="dcm.version"/>

	<target name="main">

		<!-- Ensure that we have a current build of dcm.*.jar. -->
		<ant antfile="build-dcm.ant.xml" target="all" dir="."/>

		<!-- Create the new directory for this distribution. -->
		<property name="distro" location="dcm-distros/dcm_${dcm.version}"/>
		<property name="lib" location="lib"/>

		<delete dir="${distro}"/>
		<mkdir dir="${distro}"/>

		<get src="http://www.us.apache.org/dist/ant/binaries/apache-ant-1.9.4-bin.zip" dest="${lib}/ant.zip" skipexisting="true"/>

		<unzip src="${lib}/ant.zip" dest="${distro}">
			<patternset>
				<exclude name="apache-ant-*/manual/**" />
			</patternset>
		</unzip>

		<copy file="${lib}/xalan-2.7.2.jar" todir="${distro}/apache-ant-1.9.4/lib"/>
		<copy file="${lib}/serializer-2.7.2.jar" todir="${distro}/apache-ant-1.9.4/lib"/>

		<!-- Copy a bunch of files to the new directory. -->
		<copy todir="${distro}">
			<fileset dir=".">
				<include name="Apache*.txt"/>
				<include name="build-dcm.ant.xml"/>
				<include name="deploy.ant.xml"/>
				<include name="distro.ant.xml"/>
				<include name="dist/**"/>
				<include name="imports/**"/>
				<include name="src/*.x*"/>
				<include name="tests-deploy.ant/**"/>
				<include name="tests-wdp/**"/>
			</fileset>
		</copy>

		<!-- Create the .zip file for the entire distribution. -->
		<zip basedir="${distro}" destfile="${distro}.zip"/>

		<!-- Create the .zip file for the core of the distribution. -->
		<zip destfile="${distro}_core.zip">
			<fileset dir="${distro}">
				<exclude name="apache-ant-*/**"/>
				<include name="*/**"/>
			</fileset>
		</zip>

		<!-- Create the .zip file for the ANT portion of the distribution. -->
		<zip destfile="${distro}_ant.zip">
			<fileset dir="${distro}">
				<include name="apache-ant-*/**"/>
			</fileset>
		</zip>

		<echo/>
		<echo>***********************************************************</echo>
		<echo/>

		<!-- 
	    Now that we have a CMAN distribution, create the UCD plugin. 
	  -->

		<!-- Copy the required base DCM files, which is similar to the DCM distro but smaller. -->
		<delete dir="tmp"/>
		<mkdir dir="tmp"/>
		<mkdir dir="tmp/dcm"/>
		<copy todir="tmp/dcm">
			<fileset dir=".">
				<include name="Apache*.txt"/>
				<include name="deploy.ant.xml"/>
				<include name="dist/**"/>
				<include name="src/*.x*"/>
			</fileset>
		</copy>
		<copy todir="tmp/dcm">
			<fileset dir="${distro}">
				<include name="apache-ant-*/**"/>
				<exclude name="apache-ant-*/manual/**"/>
			</fileset>
		</copy>
		<copy todir="tmp">
			<fileset dir="UrbanCode">
				<include name="**"/>
			</fileset>
		</copy>

		<!-- Create the .zip file for the DCM UCD plugin. -->
		<zip basedir="tmp" destfile="${distro}_plugin.zip"/>
	</target>

	<target name="clean">
		<ant antfile="build-dcm.ant.xml" target="clean" dir="." />
		<delete dir="dcm-distros" />
		<delete file="${lib}/ant.zip" />
		<delete dir="tmp" />
	</target>

</project>
